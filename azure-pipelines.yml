trigger:
- none   # enable when ready

pool:
  vmImage: ubuntu-latest

variables:
  acrName: "allvysharedacr"
  acrLoginServer: "$(acrName).azurecr.io"
  imageName: "hrms-service"

steps:

# 1️⃣ Checkout source
- checkout: self
  clean: true

# 2️⃣ Azure Login + ACR Login
- task: AzureCLI@2
  displayName: Azure Login + ACR Login
  inputs:
    azureSubscription: "agent-route-final-sc"
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      az acr login --name $(acrName)

# 3️⃣ Enable Docker Buildx (Multi-Arch)
- script: |
    docker buildx create --name multiarch-builder --use || true
    docker buildx inspect --bootstrap
  displayName: Enable Docker Buildx

# 4️⃣ Build & Push Docker Image (Multi-Arch + BuildId + latest)
- script: |
    docker buildx build \
      --platform linux/amd64,linux/arm64 \
      -t $(acrLoginServer)/$(imageName):$(Build.BuildId) \
      -t $(acrLoginServer)/$(imageName):latest \
      --push \
      .
  displayName: Build & Push Multi-Arch Image

# 5️⃣ Copy Kubernetes Manifests
- task: CopyFiles@2
  displayName: Copy Kubernetes Manifests
  inputs:
    contents: "manifests/*.yaml"
    targetFolder: "$(Build.ArtifactStagingDirectory)/manifests"

# 6️⃣ Publish Manifests Artifact
- task: PublishPipelineArtifact@1
  displayName: Publish Manifests
  inputs:
    targetPath: "$(Build.ArtifactStagingDirectory)/manifests"
    artifact: manifests
