trigger:
- none   # enable when ready (or set branch trigger)

pool:
  vmImage: ubuntu-latest

variables:
  acrName: "allvysharedacr"
  acrLoginServer: "$(acrName).azurecr.io"
  imageName: "hrms-service"
  buildTag: "$(Build.BuildId)"

steps:

# 1. Checkout
- checkout: self
  clean: true

# 2. Azure Login + ACR Login
- task: AzureCLI@2
  displayName: Azure Login + ACR Login
  inputs:
    azureSubscription: "agent-route-final-sc"
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      az acr login --name $(acrName)

# 3. Enable Docker Buildx
- script: |
    docker buildx create --name multiarch-builder --use || true
    docker buildx inspect --bootstrap
  displayName: Enable Docker Buildx

# 4. Build & Push Image (BuildId only)
- script: |
    docker buildx build \
      --platform linux/amd64,linux/arm64 \
      -t $(acrLoginServer)/$(imageName):$(buildTag) \
      --push \
      .
  displayName: Build & Push Multi-Arch Image

# 5. Copy Kubernetes Manifests
- task: CopyFiles@2
  displayName: Copy Kubernetes Manifests
  inputs:
    contents: "manifests/**/*.yaml"
    targetFolder: "$(Build.ArtifactStagingDirectory)/manifests"

# 6. Publish Manifests Artifact
- task: PublishPipelineArtifact@1
  displayName: Publish Manifests
  inputs:
    targetPath: "$(Build.ArtifactStagingDirectory)/manifests"
    artifact: manifests
